$(document).ready(function(){var e={modal:$("#editOrAddModal"),pagerObj:"",listContainer:$(".js_table_list"),uploadImageBtn:".js_upload_image",uploadProgressModal:"#uploadAppProgressModal",typeSection:".js_show_type_section",typeDownloadSection:"#js_show_type_download",typeLockSection:"#js_show_type_lock",typeSolutionSection:"#js_show_type_solution",typeListSection:"#js_show_type_list",typeHeadSection:"#js_show_type_head",typeExtraImgSection:"#js_show_extra_img_section",bannerPreview:$("#js_modal_banner_preview"),inputBanner:$("#js_modal_banner"),inputExtraImgPreview:$(".js_show_extra_img_preview"),inputExtraImg:$(".js_show_extra_img"),inputName:$("#js_modal_name"),inputType:$("#js_modal_type"),inputDownload:$("#js_modal_download"),inputLock:$("#js_modal_lock"),inputSolution:$("#js_modal_solution"),inputHead:$("#js_modal_head"),inputTitle:$("#js_modal_title"),inputKeywords:$("#js_modal_keywords"),inputDesc:$("#js_modal_description"),paramsAddBtn:$(".js_modal_params_add_btn"),paramsSection:$(".js_modal_params"),paramsCloneNode:$(".jmp_node .js_modal_param",$(".js_modal_params")),paramsSectionList:$(".jmp_list",$(".js_modal_params")),paramsSubAddBtn:".js_modal_params_sub_add_btn",paramsSubSection:$(".js_modal_sub_params"),paramsSubCloneNode:$(".jmp_sub_node .js_modal_sub_param",$(".js_modal_sub_params")),paramsSubSectionList:$(".jmp_sub_list",$(".js_modal_sub_params")),paramsSubSectionNode:".js_modal_sub_params",paramsSubSectionListNode:".jmp_sub_list",initSelectBtn:function(){e.inputDownload.select2({placeholder:"选择sdk下载文件",allowClear:!0}),e.inputType.unbind().bind("change",function(){var t=parseInt($(this).val());e.initSwitchTypeShowEvent(t)})},initSwitchTypeShowEvent:function(t){$(e.typeSection).addClass("gone"),$(".js_modal_item_img_section").removeClass("gone");switch(t){case 2:$(e.typeLockSection).removeClass("gone");break;case 4:$(e.typeSolutionSection).removeClass("gone");break;case 11:case 12:$(e.typeHeadSection).removeClass("gone");break;case 14:$(e.typeDownloadSection).removeClass("gone");break;case 15:$(".js_modal_item_img_section").addClass("gone"),$(e.typeListSection).removeClass("gone");break;case 16:$(e.typeListSection).removeClass("gone");break;case 17:$(".js_modal_item_img_section").addClass("gone"),$(e.typeExtraImgSection).removeClass("gone"),$(e.typeListSection).removeClass("gone")}},getModalSubParamsData:function(t){var n=$(".js_modal_sub_param",$(e.paramsSubSectionListNode,t)),r=n.length,i=[];return r&&n.each(function(e){var t=$(this).find("input"),n=$(this).find("select"),r={id:$.trim(t.eq(0).val()),name:$.trim(t.eq(1).val()),url:$.trim(t.eq(2).val()),target:$.trim(n.val()),sort_num:e+1};r.name.length&&i.push(r)}),i},setModalSubParamsData:function(t,n){n&&n.forEach(function(n){var r=e.paramsSubCloneNode.clone(),i=$(r).find("input"),s=$(r).find("select");i.eq(0).val(n.id),i.eq(1).val(n.name),i.eq(2).val(n.url),s.val(n.target),$(e.paramsSubSectionListNode,t).append(r)})},initModalParamsEvent:function(){e.paramsAddBtn.unbind().bind("click",function(){var t=e.paramsCloneNode.clone();e.paramsSectionList.append(t)}),$(document).on("click",".jmp_delete",function(){$(this).parents(".js_modal_param").remove()}),$(document).on("click",e.paramsSubAddBtn,function(){var t=e.paramsSubCloneNode.clone();$(this).parents(".js_modal_params_sub_section").find(".jmp_sub_list").append(t)}),$(document).on("click",".jmp_sub_delete",function(){$(this).parents(".js_modal_sub_param").remove()})},getModalParamsData:function(){var t=$(".js_modal_param",e.paramsSectionList),n=t.length,r=[];return n&&t.each(function(t){var n=$(this).find("input"),i=$(this).find("select"),s=$(this).find("textarea"),o={id:$.trim(n.eq(0).val()),title:$.trim(n.eq(1).val()),sub_title:$.trim(n.eq(2).val()),pic:$.trim(n.eq(3).val()),position:$.trim(i.val()),content:$.trim(s.val()),links:e.getModalSubParamsData($(this)),sort_num:t+1};o.content.length&&r.push(o)}),r},setModalParamsData:function(t){if(t){var n=document.global_config_data.img_host;t.forEach(function(t){var r=e.paramsCloneNode.clone(),i=$(r).find("input"),s=$(r).find("select"),o=$(r).find("textarea");i.eq(0).val(t.id),i.eq(1).val(t.title),i.eq(2).val(t.sub_title),i.eq(3).val(t.pic),t.pic&&t.pic.length&&$(r).find(".js_modal_item_img_preview").attr("src",n+t.pic).removeClass("gone"),s.val(t.position),o.val(t.content),t.links&&e.setModalSubParamsData($(r),t.links),e.paramsSectionList.append(r)})}},clearModalParamsData:function(){e.paramsSectionList.html(""),e.paramsSubSectionList.html("")},setModalFormData:function(t){var n=e.modal.find(".modal-title");n.html(n.data("edit"));var r=document.global_config_data.img_host;e.inputName.val(t.name),e.inputBanner.val(t.banner),e.bannerPreview.attr("src",r+t.banner).removeClass("gone"),e.inputType.val(t.page_type_id).prop("disabled",!0),e.inputTitle.val(t.title),e.inputKeywords.val(t.keywords),e.inputDesc.val(t.description);var i=parseInt(t.page_type_id);switch(i){case 2:e.inputLock.val(t.extra);break;case 4:e.inputSolution.val(t.extra);break;case 11:case 12:e.inputHead.val(t.extra);break;case 14:e.inputDownload.select2("val",t.extra.split(","));break;case 15:$(".js_modal_item_img_section").addClass("gone");case 16:case 17:t.extra&&t.extra.length&&e.inputExtraImgPreview.attr("src",r+t.extra).removeClass("gone"),t.contents&&e.setModalParamsData(t.contents)}e.initSwitchTypeShowEvent(i)},clearModalFormData:function(){var t=e.modal.find(".modal-title");t.html(t.data("new")),e.inputTitle.val(""),e.inputKeywords.val(""),e.inputDesc.val(""),e.inputBanner.val(""),e.inputExtraImg.val(""),e.bannerPreview.attr("src","").addClass("gone"),e.inputExtraImgPreview.attr("src","").addClass("gone"),e.inputName.val(""),e.inputHead.val(""),e.inputType.val("").prop("disabled",!1),e.inputDownload.select2("val",""),$(e.typeSection).addClass("gone"),$(".js_modal_item_img_section").removeClass("gone"),e.clearModalParamsData()},initUploadEvent:function(){$(document).on("click",e.uploadImageBtn,function(){var t=$(this),n=$(e.uploadProgressModal);$(this).uploadImage("/upload/upload-image",{request_type:"ajax"},function(e){var r=t.data("id"),i=t.data("parent");if(e.res){var s="";i.length&&(s=t.parents(i)),$(r,s).val(e.path),$(r+"_preview",s).attr("src",e.url).removeClass("gone")}n.modal("hide"),$(".progress-bar",n).css("width",0)},function(e){n.modal({backdrop:"static",keyboard:!1}),$(".progress-bar",n).css("width",e+"%")})})},initBtnEvent:function(){$(document).on("click",".js_edit",function(){e.clearModalFormData();var t=e.modal.find(".js_submit"),n=$(this),r=n.parents("tr"),i=r.data("id"),s=r.data("info");i&&s&&e.setModalFormData(s),e.modal.modal(),t.unbind().bind("click",function(){var t={id:i,name:$.trim(e.inputName.val()),title:$.trim(e.inputTitle.val()),keywords:$.trim(e.inputKeywords.val()),extraImg:$.trim(e.inputExtraImg.val()),description:$.trim(e.inputDesc.val()),banner:$.trim(e.inputBanner.val()),page_type_id:parseInt($.trim(e.inputType.val())),url:$("#js_modal_type").find("option:checked").data("url"),download_ids:$.trim(e.inputDownload.select2("val")),lock_id:$.trim(e.inputLock.val()),solution_id:$.trim(e.inputSolution.val()),head:$.trim(e.inputHead.val()),contents:e.getModalParamsData()},n={banner:"请上传banner 图",name:"请输入单页名称",page_type_id:"请选择单页类型"};for(var s in n)if(!t[s]||t[s].length<1)return $.showToast(n[s],!1),!1;switch(t.page_type_id){case 2:t.extra=t.lock_id;break;case 4:t.extra=t.solution_id;break;case 11:case 12:t.extra=t.head;break;case 14:if(!t.download_ids||t.download_ids.length<1)return $.showToast("请选择下载文件",!1),!1;t.extra=t.download_ids;break;case 15:if(!t.contents||t.contents.length<1)return $.showToast("请添加列表内容",!1),!1;break;case 16:if(!t.contents||t.contents.length<1)return $.showToast("请添加列表内容",!1),!1;break;case 17:if(!t.contents||t.contents.length<1)return $.showToast("请添加列表内容",!1),!1;t.extra=t.extraImg}$.wpost("/page/update-page-ajax",t,function(n){t.id?r.replaceWith(n):e.listContainer.prepend(n),$.showToast("保存成功",!0),e.modal.modal("hide")})})}),$(document).on("click",".js_delete",function(){var e=$(this),t=e.parents("tr"),n=t.attr("data-id");$.confirm({content:"确认删除吗",success:function(){$.wpost("/page/delete-page-ajax",{id:n},function(){$.showToast("删除成功",!0),e.parents("tr").remove()})}})});var t=function(e,t){t.length==0&&(t=$(e.parents("tr")));var n;e.hasClass("js_up")?n=t.prev()[0]:n=t.next()[0];if(!n)return!1;e.hasClass("js_up")?$(n).before(t):$(n).after(t)};$(document).on("click",".js_up,.js_down",function(){var e=$(this),n=$(e.parents(".js_modal_param")[0]);t(e,n)}),$(document).on("click",".js_sub_up,.js_sub_down",function(){var e=$(this),n=$(e.parents(".js_modal_sub_param")[0]);t(e,n)})},run:function(){e.initSelectBtn(),e.initUploadEvent(),e.initModalParamsEvent(),e.initBtnEvent()}};e.run()});